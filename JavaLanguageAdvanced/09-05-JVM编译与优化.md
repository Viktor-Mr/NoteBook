#  è¿è¡ŒæœŸä¼˜åŒ–

## 1.å³æ—¶ç¼–è¯‘

**åˆ†å±‚ç¼–è¯‘**

ï¼ˆTieredCompilationï¼‰



æ ·ä¾‹ï¼š

```java
public class JIT1 {
    // -XX:+PrintCompilation -XX:-DoEscapeAnalysis å…³é—­é€ƒé€¸åˆ†æ
    public static void main(String[] args) {
        for (int i = 0; i < 200; i++) {
            long start = System.nanoTime();
            for (int j = 0; j < 1000; j++) {
                new Object();
            }
            long end = System.nanoTime();
            System.out.printf("%d\t%d\n",i,(end - start));
        }
    }
}
```

```java
0	32100
1	21700
2	20500
3	20600
    ....
78	7800
79	7800
80	8800
81	7900
    ....
194	300
195	300
196	300
197	300
198	300
199	300    
```

åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

JVM å°†æ‰§è¡ŒçŠ¶æ€åˆ†æˆäº† 5 ä¸ªå±‚æ¬¡ï¼š

* 0 å±‚ï¼Œè§£é‡Šæ‰§è¡Œï¼ˆInterpreterï¼‰

* 1 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆä¸å¸¦ profilingï¼‰

* 2 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦åŸºæœ¬çš„ profilingï¼‰

* 3 å±‚ï¼Œä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦å®Œå…¨çš„ profilingï¼‰

* 4 å±‚ï¼Œä½¿ç”¨ C2 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œ

> profifiling æ˜¯æŒ‡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ”¶é›†ä¸€äº›ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„æ•°æ®ï¼Œä¾‹å¦‚ã€æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ã€‘ã€å¾ªç¯çš„å›è¾¹æ¬¡æ•°ã€‘ç­‰



<font color='red'>**å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ä¸è§£é‡Šå™¨çš„åŒºåˆ«**</font>

* è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºæœºå™¨ç ï¼Œä¸‹æ¬¡å³ä½¿é‡åˆ°ç›¸åŒçš„å­—èŠ‚ç ï¼Œä»ä¼šæ‰§è¡Œé‡å¤çš„è§£é‡Š

* JIT æ˜¯å°†ä¸€äº›å­—èŠ‚ç ç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œå¹¶å­˜å…¥ Code Cacheï¼Œä¸‹æ¬¡é‡åˆ°ç›¸åŒçš„ä»£ç ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€å†ç¼–è¯‘

* è§£é‡Šå™¨æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºé’ˆå¯¹æ‰€æœ‰å¹³å°éƒ½é€šç”¨çš„æœºå™¨ç 

* JIT ä¼šæ ¹æ®å¹³å°ç±»å‹ï¼Œç”Ÿæˆå¹³å°ç‰¹å®šçš„æœºå™¨ç 



<font color='red'>**ç¼–è¯‘æ‰§è¡Œ ä¸ è§£é‡Šæ‰§è¡Œçš„åŒºåˆ«**</font>

ç¼–è¯‘æ‰§è¡Œ:ç¼–è¯‘å™¨å°†ä»£ç ç¼–è¯‘æˆæœºå™¨ç ,ç„¶ååœ¨è¿›è¡Œæ‰§è¡Œ,å› ä¸ºæ˜¯æ•´ä½“ç¼–è¯‘,æ‰€ä»¥ä¼šäº§ç”Ÿç¼–è¯‘åçš„æœºå™¨ç æ–‡ä»¶ 

è§£é‡Šæ‰§è¡Œ:è§£é‡Šå™¨ä¼šå°†ä»£ç ä¸€å¥ä¸€å¥çš„è¿›è¡Œè§£é‡Š,è§£é‡Šä¸€å¥è¿è¡Œä¸€å¥



â€‹	å¯¹äºå æ®å¤§éƒ¨åˆ†çš„ä¸å¸¸ç”¨çš„ä»£ç ï¼Œæˆ‘ä»¬æ— éœ€è€—è´¹æ—¶é—´å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯é‡‡å–è§£é‡Šæ‰§è¡Œçš„æ–¹å¼è¿è¡Œï¼›å¦ä¸€æ–¹é¢ï¼Œå¯¹äºä»…å æ®å°éƒ¨åˆ†çš„çƒ­ç‚¹ä»£ç ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œä»¥è¾¾åˆ°ç†æƒ³çš„è¿è¡Œé€Ÿåº¦ã€‚ æ‰§è¡Œæ•ˆç‡ä¸Šç®€å•æ¯”è¾ƒä¸€ä¸‹ Interpreter < C1 < C2ï¼Œæ€»çš„ç›®æ ‡æ˜¯å‘ç°çƒ­ç‚¹ä»£ç ï¼ˆhotspotåç§°çš„ç”±æ¥ï¼‰ï¼Œä¼˜åŒ–ä¹‹



â€‹	å¦ä¸€ç§ä¼˜åŒ–æ‰‹æ®µç§°ä¹‹ä¸º<font color='red'>**é€ƒé€¸åˆ†æ**</font>ï¼Œå‘ç°æ–°å»ºçš„å¯¹è±¡æ˜¯å¦é€ƒé€¸ï¼Œå¦‚æœå­˜åœ¨é€ƒé€¸çš„è¡Œä¸ºï¼Œå¯ä»¥æ ¹æ®æƒ…å†µæ¥å†³å®šæ˜¯å¦åˆ›å»ºã€‚

â€‹	ä½¿ç”¨ -XX:-DoEscapeAnalysis å…³é—­é€ƒé€¸åˆ†æï¼Œå†è¿è¡Œåˆšæ‰çš„ç¤ºä¾‹è§‚å¯Ÿç»“æœã€‚

å…³é—­é€ƒé€¸åˆ†æï¼š

```java
194	5700
195	5700
196	4700
197	5600
198	5600
199	5600
```



å‚è€ƒèµ„æ–™ï¼šhttps://docs.oracle.com/en/java/javase/12/vm/java-hotspot-virtual-machine-performance-enhancements.html#GUID-D2E3DC58-D18B-4A6C-8167-4A1DFB4888E4





## 2.æ–¹æ³•å†…è”

æ–¹æ³•å†…è”ï¼ˆInliningï¼‰

```java
private static int square(final int i) { return i * i; }
```

````java
System.out.println(square(9));
````

å¦‚æœå‘ç° square æ˜¯çƒ­ç‚¹æ–¹æ³•ï¼Œå¹¶ä¸”é•¿åº¦ä¸å¤ªé•¿æ—¶ï¼Œä¼šè¿›è¡Œå†…è”ï¼Œæ‰€è°“çš„å†…è”å°±æ˜¯æŠŠæ–¹æ³•å†…ä»£ç æ‹·è´ã€ç²˜è´´åˆ°è°ƒç”¨è€…çš„ä½ç½®ï¼š

```java
System.out.println(9 * 9);
```

è¿˜èƒ½å¤Ÿè¿›è¡Œå¸¸é‡æŠ˜å ï¼ˆconstant foldingï¼‰çš„ä¼˜åŒ–

```java
System.out.println(81);
```



ä¸¾ä¾‹ï¼š

```java
public class JIT2 {
    // -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining ï¼ˆè§£é”éšè—å‚æ•°ï¼‰æ‰“å° inlining ä¿¡æ¯
    // -XX:CompileCommand=dontinline,*JIT2.square ç¦æ­¢æŸä¸ªæ–¹æ³• inlining
    // -XX:+PrintCompilation æ‰“å°ç¼–è¯‘ä¿¡æ¯
    public static void main(String[] args) {
        int x = 0;
        for (int i = 0; i < 500; i++) {
            long start = System.nanoTime();
            for (int j = 0; j < 1000; j++) {
                x = square(9);

            }
            long end = System.nanoTime();
            System.out.printf("%d\t%d\t%d\n",i,x,(end - start));
        }
    }
    private static int square(final int i) {
        return i * i;
    }
}
```

```java
0	81	26500
1	81	18600
2	81	15100
    ....
495	81	0
496	81	0
497	81	0
498	81	100
499	81	0    
```

çƒ­ç‚¹ä»£ç  4bytesçš„æ–¹æ³•ï¼ˆå¹¶ä¸”è¶³å¤Ÿå° ï¼‰è¿›è¡Œå†…è”

![](http://mk-images.tagao.top/img/202206071956049.png?imageslim)

å…³é—­æ–¹æ³•å†…è”ï¼š

```shell
 -XX:CompileCommand=dontinline,*JIT2.square ç¦æ­¢æŸä¸ªæ–¹æ³• inlining
```

```java
495	81	2100
496	81	2100
497	81	2200
498	81	2100
499	81	2100
```



## 3.å­—æ®µä¼˜åŒ–

JMH åŸºå‡†æµ‹è¯•è¯·å‚è€ƒï¼šhttp://openjdk.java.net/projects/code-tools/jmh/

åˆ›å»º maven å·¥ç¨‹ï¼Œæ·»åŠ ä¾èµ–å¦‚ä¸‹

```xml
<properties>
    <maven.compiler.source>8</maven.compiler.source>
    <maven.compiler.target>8</maven.compiler.target>
    <jmh.version>1.0</jmh.version>
    <uberjar.name>benchmarks</uberjar.name>
</properties>
<dependencies>
    <dependency>
        <groupId>org.openjdk.jmh</groupId>
        <artifactId>jmh-core</artifactId>
        <version>${jmh.version}</version>
    </dependency>
    <dependency>
        <groupId>org.openjdk.jmh</groupId>
        <artifactId>jmh-generator-annprocess</artifactId>
        <version>${jmh.version}</version>
        <scope>provided</scope>
    </dependency>
</dependencies>
```

ç¼–å†™åŸºå‡†æµ‹è¯•ä»£ç ï¼š

```java
@Warmup(iterations = 2, time = 1)
@Measurement(iterations = 5, time = 1)
@State(Scope.Benchmark)
public class Benchmark1 {

    int[] elements = randomInts(1_000);

    private static int[] randomInts(int size) {
        Random random = ThreadLocalRandom.current();
        int[] values = new int[size];
        for (int i = 0; i < size; i++) {
            values[i] = random.nextInt();
        }
        return values;
    }

    @Benchmark
    public void test1() {
        for (int i = 0; i < elements.length; i++) {
            doSum(elements[i]);
        }
    }

    @Benchmark
    public void test2() {
        int[] local = this.elements;
        for (int i = 0; i < local.length; i++) {
            doSum(local[i]);
        }
    }

    @Benchmark
    public void test3() {
        for (int element : elements) {
            doSum(element);
        }
    }

    static int sum = 0;

    @CompilerControl(CompilerControl.Mode.DONT_INLINE)
    static void doSum(int x) {
        sum += x;
    }


    public static void main(String[] args) throws RunnerException {
        Options opt = new OptionsBuilder()
                .include(Benchmark1.class.getSimpleName())
                .forks(1)
                .build();

        new Runner(opt).run();
    }
}
```

é¦–å…ˆå¯ç”¨ doSum çš„æ–¹æ³•å†…è”ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼ˆæ¯ç§’ååé‡ï¼Œåˆ†æ•°è¶Šé«˜çš„æ›´å¥½ï¼‰ï¼š

```java
Benchmark                     Mode  Samples        Score  Score error  Units
c_05_JIT.Benchmark1.test1    thrpt        5  3679681.248   475195.412  ops/s
c_05_JIT.Benchmark1.test2    thrpt        5  3780179.007    79897.618  ops/s
c_05_JIT.Benchmark1.test3    thrpt        5  3781122.248   213785.434  ops/s

```



æ¥ä¸‹æ¥ç¦ç”¨ doSum æ–¹æ³•å†…è”

```java
@CompilerControl(CompilerControl.Mode.DONT_INLINE) 
static void doSum(int x) {
    sum += x; 
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

```java
Benchmark                     Mode  Samples       Score  Score error  Units
c_05_JIT.Benchmark1.test1    thrpt        5  458296.820    15153.615  ops/s
c_05_JIT.Benchmark1.test2    thrpt        5  558828.641   174768.540  ops/s
c_05_JIT.Benchmark1.test3    thrpt        5  584056.012    21642.692  ops/s
```





åˆ†æï¼š

åœ¨åˆšæ‰çš„ç¤ºä¾‹ä¸­ï¼ŒdoSum æ–¹æ³•æ˜¯å¦å†…è”ä¼šå½±å“ elements æˆå‘˜å˜é‡è¯»å–çš„ä¼˜åŒ–ï¼šå¦‚æœ doSum æ–¹æ³•å†…è”äº†ï¼Œåˆšæ‰çš„ test1 æ–¹æ³•ä¼šè¢«ä¼˜åŒ–æˆä¸‹é¢çš„æ ·å­ï¼ˆä¼ªä»£ç ï¼‰ï¼š

```java
@Benchmark 
public void test1() { 
// elements.length é¦–æ¬¡è¯»å–ä¼šç¼“å­˜èµ·æ¥ -> int[] local 
for (int i = 0; i < elements.length; i++) { // åç»­ 999 æ¬¡ æ±‚é•¿åº¦ <- local 
		sum += elements[i]; // 1000 æ¬¡å–ä¸‹æ ‡ i çš„å…ƒç´  <- local 
	} 
}
```

å¯ä»¥èŠ‚çœ 1999 æ¬¡ Field è¯»å–æ“ä½œ

ä½†å¦‚æœ doSum æ–¹æ³•æ²¡æœ‰å†…è”ï¼Œåˆ™ä¸ä¼šè¿›è¡Œä¸Šé¢çš„ä¼˜åŒ–



## 4.åå°„ä¼˜åŒ–



```java
public class Reflect1 {
    public static void foo() {
        System.out.println("foo...");
    }

    public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException {
        Method foo = Reflect1.class.getMethod("foo");
        for (int i = 0; i <= 16; i++) {
            System.out.printf("%d\t", i);
            foo.invoke(null);
        }
        System.in.read();
    }
}

```

foo.invoke å‰é¢ 0 ~ 15 æ¬¡è°ƒç”¨ä½¿ç”¨çš„æ˜¯ MethodAccessor çš„ NativeMethodAccessorImpl å®ç°

![](http://mk-images.tagao.top/img/202206072010996.png?imageslim)

![](http://mk-images.tagao.top/img/202206072014648.png?imageslim)

å½“è°ƒç”¨åˆ°ç¬¬ 16 æ¬¡ï¼ˆä»0å¼€å§‹ç®—ï¼‰æ—¶ï¼Œä¼šé‡‡ç”¨è¿è¡Œæ—¶ç”Ÿæˆçš„ç±»ä»£æ›¿æ‰æœ€åˆçš„å®ç°ï¼Œå¯ä»¥é€šè¿‡ debug å¾—åˆ°ç±»åä¸º sun.reflflect.GeneratedMethodAccessor1



å¯ä»¥ä½¿ç”¨é˜¿é‡Œçš„ arthas å·¥å…·ï¼š

```shell
java -jar arthas-boot.jar 
[INFO] arthas-boot version: 3.1.1 
[INFO] Found existing java process, please choose one and hit RETURN. 
* [1]: 13065 cn.itcast.jvm.t3.reflect.Reflect1
```

é€‰æ‹© 1 å›è½¦è¡¨ç¤ºåˆ†æè¯¥è¿›ç¨‹

```shell
1
[INFO] arthas home: /root/.arthas/lib/3.1.1/arthas 
[INFO] Try to attach process 13065 
[INFO] Attach process 13065 success. 
[INFO] arthas-client connect 127.0.0.1 3658 
,---. ,------. ,--------.,--. ,--. ,---. ,---. 
/ O \ | .--. ''--. .--'| '--' | / O \ ' .-' 
| .-. || '--'.' | | | .--. || .-. |`. `-. 
| | | || |\ \ | | | | | || | | |.-' | 
`--' `--'`--' '--' `--' `--' `--'`--' `--'`-----' 

wiki https://alibaba.github.io/arthas 
tutorials https://alibaba.github.io/arthas/arthas-tutorials 
version 3.1.1 
pid 13065 
time 2019-06-10 12:23:54
```

å†è¾“å…¥ã€jad + ç±»åã€‘æ¥è¿›è¡Œåç¼–è¯‘

```java
$ jad sun.reflect.GeneratedMethodAccessor1 

ClassLoader: 

+-sun.reflect.DelegatingClassLoader@15db9742 
	+-sun.misc.Launcher$AppClassLoader@4e0e2f2a 
		+-sun.misc.Launcher$ExtClassLoader@2fdb006e 

Location: 

/*
* Decompiled with CFR 0_132. 
* Could not load the following classes: 
* cn.itcast.jvm.t3.reflect.Reflect1 
*/ 

package sun.reflect; 
import cn.itcast.jvm.t3.reflect.Reflect1; 
import java.lang.reflect.InvocationTargetException; 
import sun.reflect.MethodAccessorImpl; 
public class GeneratedMethodAccessor1 extends MethodAccessorImpl { 
    /** Loose catch block 
        * Enabled aggressive block sorting 
        * Enabled unnecessary exception pruning 
        * Enabled aggressive exception aggregation 
        * Lifted jumps to return sites 
    */

public Object invoke(Object object, Object[] arrobject)throws InvocationTargetException { 
// æ¯”è¾ƒå¥‡è‘©çš„åšæ³•ï¼Œå¦‚æœæœ‰å‚æ•°ï¼Œé‚£ä¹ˆæŠ›éæ³•å‚æ•°å¼‚å¸¸ 
    block4 : { 
        if (arrobject == null || arrobject.length == 0) break block4; 
        throw new IllegalArgumentException(); 
    }

    try {
        // å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æ˜¯ç›´æ¥è°ƒç”¨äº†ğŸ˜±ğŸ˜±ğŸ˜± 
        Reflect1.foo(); 
        // å› ä¸ºæ²¡æœ‰è¿”å›å€¼ 
        return null; 
    }catch (Throwable throwable) { 
        throw new InvocationTargetException(throwable); 
     }catch (ClassCastException | NullPointerException runtimeException) { 
       	throw new IllegalArgumentException(Object.super.toString()); 
      } 
    } 
}

Affect(row-cnt:1) cost in 1540 ms
```

**æ³¨æ„**

é€šè¿‡æŸ¥çœ‹ ReflectionFactory æºç å¯çŸ¥

* sun.reflflect.noInflflation å¯ä»¥ç”¨æ¥ç¦ç”¨è†¨èƒ€

  ï¼ˆç›´æ¥ç”Ÿæˆ GeneratedMethodAccessor1ï¼Œä½†é¦–æ¬¡ç”Ÿæˆæ¯”è¾ƒè€—æ—¶ï¼Œå¦‚æœä»…åå°„è°ƒç”¨ä¸€æ¬¡ï¼Œä¸åˆ’ç®—ï¼‰

* sun.reflflect.inflflationThreshold å¯ä»¥ä¿®æ”¹è†¨èƒ€é˜ˆå€¼